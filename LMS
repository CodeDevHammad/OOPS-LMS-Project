#include <iostream>
#include <fstream>
#include <string>
#include <vector>

using namespace std;

class User {
protected:
    string username;
    string password;
    string role;

public:
    User(string uname = "", string pwd = "", string r = "")
        : username(uname), password(pwd), role(r) {
    }

    virtual ~User() {}

    string getUsername() const { return username; }
    string getPassword() const { return password; }
    string getRole() const { return role; }

    void setPassword(string pwd) { password = pwd; }

    virtual void displayMenu() = 0;
    virtual string getUserType() const = 0;
};

class Admin : public User {
public:
    Admin(string uname = "", string pwd = "")
        : User(uname, pwd, "admin") {
    }

    void displayMenu() override {
        cout << "\n--- Admin Menu ---\n";
        cout << "1) Create user\n2) Delete user\n3) Add course\n4) Remove course\n";
        cout << "5) Assign teacher to course\n6) View all records\n7) Logout\nSelect: ";
    }

    string getUserType() const override { return "Administrator"; }
};

class Student : public User {
private:
    string fullName;
    int age;

public:
    Student(string uname = "", string pwd = "", string fname = "", int a = 0)
        : User(uname, pwd, "student"), fullName(fname), age(a) {
    }

    string getFullName() const { return fullName; }
    int getAge() const { return age; }
    void setFullName(string fname) { fullName = fname; }
    void setAge(int a) { age = a; }

    void displayMenu() override {
        cout << "\n--- Student Menu (" << username << ") ---\n";
        cout << "1) View available courses\n2) Enroll in course\n3) View my courses\n";
        cout << "4) Submit assignment\n5) View course materials\n6) Logout\nSelect: ";
    }

    string getUserType() const override { return "Student"; }
};

class Teacher : public User {
public:
    Teacher(string uname = "", string pwd = "")
        : User(uname, pwd, "teacher") {
    }

    void displayMenu() override {
        cout << "\n--- Teacher Menu (" << username << ") ---\n";
        cout << "1) View my courses\n2) View enrolled students\n3) Upload material\n";
        cout << "4) View student assignments\n5) Logout\nSelect: ";
    }

    string getUserType() const override { return "Teacher"; }
};

class CourseInfo {
private:
    string courseId;
    string title;
    string teacherUsername;

public:
    CourseInfo(string id = "", string t = "", string teacher = "")
        : courseId(id), title(t), teacherUsername(teacher) {
    }

    string getId() const { return courseId; }
    string getTitle() const { return title; }
    string getTeacher() const { return teacherUsername; }

    void setTitle(string t) { title = t; }
    void setTeacher(string teacher) { teacherUsername = teacher; }
};

vector<User*> users;
vector<CourseInfo> courses;
vector<pair<string, string>> enrollments;

const string USERS_FILE = "users.txt";
const string STUDENTS_FILE = "students.txt";
const string COURSES_FILE = "courses.txt";
const string ENROLLMENTS_FILE = "enrollments.txt";

vector<string> splitLine(const string& line, char delim = '|') {
    vector<string> parts;
    string cur;
    for (size_t i = 0; i < line.size(); ++i) {
        if (line[i] == delim) {
            parts.push_back(cur);
            cur.clear();
        }
        else {
            cur.push_back(line[i]);
        }
    }
    parts.push_back(cur);
    return parts;
}

void ensureFileExists(const string& filename) {
    ifstream ifs(filename.c_str());
    if (!ifs.good()) {
        ofstream ofs(filename.c_str());
    }
}

void loadUsers() {
    ensureFileExists(USERS_FILE);
    for (size_t i = 0; i < users.size(); ++i) delete users[i];
    users.clear();

    ifstream ifs(USERS_FILE.c_str());
    string line;
    while (getline(ifs, line)) {
        if (line.empty()) continue;
        auto p = splitLine(line);
        if (p.size() >= 3) {
            string uname = p[0], pwd = p[1], role = p[2];

            if (role == "admin") {
                users.push_back(new Admin(uname, pwd));
            }
            else if (role == "student") {
                users.push_back(new Student(uname, pwd));
            }
            else if (role == "teacher") {
                users.push_back(new Teacher(uname, pwd));
            }
        }
    }

    ensureFileExists(STUDENTS_FILE);
    ifstream sifs(STUDENTS_FILE.c_str());
    while (getline(sifs, line)) {
        if (line.empty()) continue;
        auto p = splitLine(line);
        if (p.size() >= 3) {
            string uname = p[0];
            for (size_t i = 0; i < users.size(); ++i) {
                if (users[i]->getUsername() == uname && users[i]->getRole() == "student") {
                    Student* s = dynamic_cast<Student*>(users[i]);
                    if (s) {
                        s->setFullName(p[1]);
                        try { s->setAge(stoi(p[2])); }
                        catch (...) { s->setAge(0); }
                    }
                    break;
                }
            }
        }
    }
}

void saveUsers() {
    ofstream ofs(USERS_FILE.c_str(), ios::trunc);
    ofstream sofs(STUDENTS_FILE.c_str(), ios::trunc);

    for (size_t i = 0; i < users.size(); ++i) {
        ofs << users[i]->getUsername() << '|' << users[i]->getPassword() << '|' << users[i]->getRole() << '\n';

        if (users[i]->getRole() == "student") {
            Student* s = dynamic_cast<Student*>(users[i]);
            if (s) {
                sofs << s->getUsername() << '|' << s->getFullName() << '|' << s->getAge() << '\n';
            }
        }
    }
}

void loadCourses() {
    ensureFileExists(COURSES_FILE);
    courses.clear();
    ifstream ifs(COURSES_FILE.c_str());
    string line;
    while (getline(ifs, line)) {
        if (line.empty()) continue;
        auto p = splitLine(line);
        if (p.size() >= 3) {
            courses.push_back(CourseInfo(p[0], p[1], p[2]));
        }
    }
}

void saveCourses() {
    ofstream ofs(COURSES_FILE.c_str(), ios::trunc);
    for (size_t i = 0; i < courses.size(); ++i) {
        ofs << courses[i].getId() << '|' << courses[i].getTitle() << '|' << courses[i].getTeacher() << '\n';
    }
}

void loadEnrollments() {
    ensureFileExists(ENROLLMENTS_FILE);
    enrollments.clear();
    ifstream ifs(ENROLLMENTS_FILE.c_str());
    string line;
    while (getline(ifs, line)) {
        if (line.empty()) continue;
        auto p = splitLine(line);
        if (p.size() >= 2) {
            enrollments.push_back(make_pair(p[0], p[1]));
        }
    }
}

void saveEnrollments() {
    ofstream ofs(ENROLLMENTS_FILE.c_str(), ios::trunc);
    for (size_t i = 0; i < enrollments.size(); ++i) {
        ofs << enrollments[i].first << '|' << enrollments[i].second << '\n';
    }
}

bool usernameExists(const string& uname) {
    for (size_t i = 0; i < users.size(); ++i) {
        if (users[i]->getUsername() == uname) return true;
    }
    return false;
}

User* findUser(const string& uname) {
    for (size_t i = 0; i < users.size(); ++i) {
        if (users[i]->getUsername() == uname) return users[i];
    }
    return nullptr;
}

Student* findStudentProfile(const string& uname) {
    for (size_t i = 0; i < users.size(); ++i) {
        if (users[i]->getUsername() == uname && users[i]->getRole() == "student") {
            return dynamic_cast<Student*>(users[i]);
        }
    }
    return nullptr;
}

CourseInfo* findCourse(const string& cid) {
    for (size_t i = 0; i < courses.size(); ++i) {
        if (courses[i].getId() == cid) return &courses[i];
    }
    return nullptr;
}

vector<string> getStudentEnrollments(const string& studentUsername) {
    vector<string> out;
    for (size_t i = 0; i < enrollments.size(); ++i) {
        if (enrollments[i].first == studentUsername) out.push_back(enrollments[i].second);
    }
    return out;
}

void adminCreateUser() {
    string uname, pwd, role;
    cout << "Enter new username: ";
    getline(cin, uname);
    if (uname.empty()) { cout << "Username cannot be empty.\n"; return; }
    if (usernameExists(uname)) { cout << "Username already exists.\n"; return; }
    cout << "Enter password: ";
    getline(cin, pwd);
    cout << "Enter role (admin/student/teacher): ";
    getline(cin, role);
    if (role != "admin" && role != "student" && role != "teacher") {
        cout << "Invalid role.\n"; return;
    }

    if (role == "admin") {
        users.push_back(new Admin(uname, pwd));
    }
    else if (role == "teacher") {
        users.push_back(new Teacher(uname, pwd));
    }
    else if (role == "student") {
        string fname, ageStr;
        cout << "Enter student full name: ";
        getline(cin, fname);
        cout << "Enter student age: ";
        getline(cin, ageStr);
        int age = 0;
        try { age = stoi(ageStr); }
        catch (...) { age = 0; }
        users.push_back(new Student(uname, pwd, fname, age));
    }

    saveUsers();
    cout << "User created.\n";
}

void adminDeleteUser() {
    string uname;
    cout << "Username to delete: ";
    getline(cin, uname);
    bool found = false;

    for (size_t i = 0; i < users.size(); ) {
        if (users[i]->getUsername() == uname) {
            delete users[i];
            users.erase(users.begin() + i);
            found = true;
        }
        else {
            ++i;
        }
    }
    if (!found) { cout << "User not found.\n"; return; }

    for (size_t i = 0; i < enrollments.size(); ) {
        if (enrollments[i].first == uname) enrollments.erase(enrollments.begin() + i);
        else ++i;
    }

    for (size_t i = 0; i < courses.size(); ++i) {
        if (courses[i].getTeacher() == uname) courses[i].setTeacher("");
    }

    saveUsers();
    saveEnrollments();
    saveCourses();
    cout << "User and related records removed.\n";
}

void adminAddCourse() {
    string cid, title, teacher;
    cout << "Course ID: ";
    getline(cin, cid);
    if (cid.empty()) { cout << "Course ID cannot be empty.\n"; return; }
    if (findCourse(cid)) { cout << "Course ID already exists.\n"; return; }
    cout << "Course title: ";
    getline(cin, title);
    cout << "Assign teacher username (leave blank to assign later): ";
    getline(cin, teacher);
    if (!teacher.empty() && !usernameExists(teacher)) {
        cout << "Teacher username does not exist. Course will be created without teacher.\n";
        teacher.clear();
    }
    courses.push_back(CourseInfo(cid, title, teacher));
    saveCourses();
    cout << "Course added.\n";
}

void adminRemoveCourse() {
    string cid;
    cout << "Course ID to remove: ";
    getline(cin, cid);
    bool found = false;
    for (size_t i = 0; i < courses.size(); ) {
        if (courses[i].getId() == cid) {
            courses.erase(courses.begin() + i);
            found = true;
        }
        else ++i;
    }
    if (!found) { cout << "Course not found.\n"; return; }

    for (size_t i = 0; i < enrollments.size(); ) {
        if (enrollments[i].second == cid) enrollments.erase(enrollments.begin() + i);
        else ++i;
    }

    saveCourses();
    saveEnrollments();
    cout << "Course removed and related enrollments deleted.\n";
}

void adminAssignTeacher() {
    string cid, teacher;
    cout << "Course ID: ";
    getline(cin, cid);
    CourseInfo* c = findCourse(cid);
    if (!c) { cout << "Course not found.\n"; return; }
    cout << "Teacher username to assign (leave blank to unassign): ";
    getline(cin, teacher);
    if (!teacher.empty() && !usernameExists(teacher)) {
        cout << "Teacher username does not exist.\n"; return;
    }
    c->setTeacher(teacher);
    saveCourses();
    cout << "Assignment updated.\n";
}

void adminViewAll() {
    cout << "\n--- Users ---\n";
    for (size_t i = 0; i < users.size(); ++i) {
        cout << users[i]->getUsername() << " (" << users[i]->getUserType() << ")\n";
    }
    cout << "\n--- Students ---\n";
    for (size_t i = 0; i < users.size(); ++i) {
        if (users[i]->getRole() == "student") {
            Student* s = dynamic_cast<Student*>(users[i]);
            if (s) {
                cout << s->getUsername() << " - " << s->getFullName() << " - age " << s->getAge() << '\n';
            }
        }
    }
    cout << "\n--- Courses ---\n";
    for (size_t i = 0; i < courses.size(); ++i) {
        cout << courses[i].getId() << " | " << courses[i].getTitle() << " | teacher: "
            << (courses[i].getTeacher().empty() ? "(none)" : courses[i].getTeacher()) << '\n';
    }
    cout << "\n--- Enrollments ---\n";
    for (size_t i = 0; i < enrollments.size(); ++i) {
        cout << enrollments[i].first << " -> " << enrollments[i].second << '\n';
    }
    cout << '\n';
}

void studentViewAvailableCourses() {
    cout << "\nAvailable courses:\n";
    for (size_t i = 0; i < courses.size(); ++i) {
        cout << courses[i].getId() << " | " << courses[i].getTitle() << " | teacher: "
            << (courses[i].getTeacher().empty() ? "(none)" : courses[i].getTeacher()) << '\n';
    }
}

void studentEnroll(const string& studentUsername) {
    string cid;
    cout << "Enter Course ID to enroll: ";
    getline(cin, cid);
    CourseInfo* c = findCourse(cid);
    if (!c) { cout << "Course not found.\n"; return; }
    for (size_t i = 0; i < enrollments.size(); ++i) {
        if (enrollments[i].first == studentUsername && enrollments[i].second == cid) {
            cout << "Already enrolled.\n"; return;
        }
    }
    enrollments.push_back(make_pair(studentUsername, cid));
    saveEnrollments();
    cout << "Enrolled in " << cid << '\n';
}

void studentViewMyCourses(const string& studentUsername) {
    auto my = getStudentEnrollments(studentUsername);
    if (my.empty()) { cout << "No enrollments.\n"; return; }
    cout << "Your courses:\n";
    for (size_t i = 0; i < my.size(); ++i) {
        CourseInfo* c = findCourse(my[i]);
        if (c) {
            cout << c->getId() << " | " << c->getTitle() << " | teacher: "
                << (c->getTeacher().empty() ? "(none)" : c->getTeacher()) << '\n';
        }
        else {
            cout << my[i] << " (no longer exists)\n";
        }
    }
}

void studentSubmitAssignment(const string& studentUsername) {
    string cid, content;
    cout << "Course ID to submit assignment for: ";
    getline(cin, cid);
    bool enrolled = false;
    for (size_t i = 0; i < enrollments.size(); ++i) {
        if (enrollments[i].first == studentUsername && enrollments[i].second == cid) { enrolled = true; break; }
    }
    if (!enrolled) { cout << "You are not enrolled in that course.\n"; return; }
    cout << "Enter submission text (single line): ";
    getline(cin, content);
    string fname = "submission_" + studentUsername + "_" + cid + ".txt";
    ofstream ofs(fname.c_str(), ios::app);
    ofs << content << '\n';
    cout << "Submission saved to " << fname << '\n';
}

void studentViewMaterials(const string& studentUsername) {
    string cid;
    cout << "Enter Course ID to view materials: ";
    getline(cin, cid);

    bool enrolled = false;
    for (size_t i = 0; i < enrollments.size(); ++i) {
        if (enrollments[i].first == studentUsername && enrollments[i].second == cid) {
            enrolled = true;
            break;
        }
    }
    if (!enrolled) {
        cout << "You are not enrolled in this course.\n";
        return;
    }

    string fname = "material_" + cid + ".txt";
    ifstream ifs(fname.c_str());
    if (!ifs.good()) {
        cout << "No materials uploaded yet for this course.\n";
        return;
    }

    cout << "\n===== Course Materials for " << cid << " =====\n";
    string line;
    int lineNum = 1;
    while (getline(ifs, line)) {
        cout << lineNum++ << ". " << line << '\n';
    }
    cout << "==========================================\n";
}

void teacherViewMyCourses(const string& teacherUsername) {
    cout << "Courses you teach:\n";
    bool any = false;
    for (size_t i = 0; i < courses.size(); ++i) {
        if (courses[i].getTeacher() == teacherUsername) {
            cout << courses[i].getId() << " | " << courses[i].getTitle() << '\n';
            any = true;
        }
    }
    if (!any) cout << "(none)\n";
}

void teacherViewEnrolledStudents(const string& teacherUsername) {
    string cid;
    cout << "Enter your Course ID: ";
    getline(cin, cid);
    CourseInfo* c = findCourse(cid);
    if (!c) { cout << "Course not found.\n"; return; }
    if (c->getTeacher() != teacherUsername) {
        cout << "You are not assigned to this course.\n"; return;
    }
    cout << "Enrolled students in " << cid << ":\n";
    bool any = false;
    for (size_t i = 0; i < enrollments.size(); ++i) {
        if (enrollments[i].second == cid) {
            cout << "- " << enrollments[i].first;
            Student* sp = findStudentProfile(enrollments[i].first);
            if (sp) cout << " (" << sp->getFullName() << ")";
            cout << '\n';
            any = true;
        }
    }
    if (!any) cout << "(none)\n";
}

void teacherUploadMaterial(const string& teacherUsername) {
    string cid, text;
    cout << "Course ID to upload material for: ";
    getline(cin, cid);
    CourseInfo* c = findCourse(cid);
    if (!c) { cout << "Course not found.\n"; return; }
    if (c->getTeacher() != teacherUsername) {
        cout << "You are not assigned to this course.\n"; return;
    }
    cout << "Enter material text (single line): ";
    getline(cin, text);
    string fname = "material_" + cid + ".txt";
    ofstream ofs(fname.c_str(), ios::app);
    ofs << text << '\n';
    cout << "Material appended to " << fname << '\n';
}

void teacherViewAssignments(const string& teacherUsername) {
    string cid;
    cout << "Enter your Course ID: ";
    getline(cin, cid);

    CourseInfo* c = findCourse(cid);
    if (!c) {
        cout << "Course not found.\n";
        return;
    }
    if (c->getTeacher() != teacherUsername) {
        cout << "You are not assigned to this course.\n";
        return;
    }

    cout << "\n===== Student Assignments for " << cid << " =====\n";

    bool foundAny = false;
    for (size_t i = 0; i < enrollments.size(); ++i) {
        if (enrollments[i].second == cid) {
            string studentName = enrollments[i].first;
            string fname = "submission_" + studentName + "_" + cid + ".txt";

            ifstream ifs(fname.c_str());
            if (ifs.good()) {
                cout << "\n--- Student: " << studentName;
                Student* sp = findStudentProfile(studentName);
                if (sp) cout << " (" << sp->getFullName() << ")";
                cout << " ---\n";

                string line;
                int lineNum = 1;
                while (getline(ifs, line)) {
                    cout << "  " << lineNum++ << ". " << line << '\n';
                }
                foundAny = true;
            }
        }
    }

    if (!foundAny) {
        cout << "No assignments submitted yet for this course.\n";
    }
    cout << "==========================================\n";
}

User* authenticate() {
    string uname, pwd;
    cout << "Username: ";
    getline(cin, uname);
    cout << "Password: ";
    getline(cin, pwd);
    for (size_t i = 0; i < users.size(); ++i) {
        if (users[i]->getUsername() == uname && users[i]->getPassword() == pwd) {
            return users[i];
        }
    }
    return nullptr;
}

void ensureAdminExists() {
    loadUsers();
    bool hasAdmin = false;
    for (size_t i = 0; i < users.size(); ++i) {
        if (users[i]->getRole() == "admin") { hasAdmin = true; break; }
    }
    if (!hasAdmin) {
        cout << "No admin account found. Creating default admin (username: admin, password: admin).\n";
        users.push_back(new Admin("admin", "admin"));
        saveUsers();
    }
}

int main() {
    loadUsers();
    loadCourses();
    loadEnrollments();
    ensureAdminExists();

    cout << "OOP-based University LMS" << endl;
    cout << "==========================" << endl;
    cout << "Demonstrates 4 OOP Concepts:" << endl;
    cout << "1. Encapsulation (private members + getters/setters)" << endl;
    cout << "2. Inheritance (User -> Admin/Student/Teacher)" << endl;
    cout << "3. Polymorphism (virtual functions + dynamic_cast)" << endl;
    cout << "4. Abstraction (abstract base class)" << endl << endl;

    while (true) {
        cout << "\n1) Login\n2) Exit\nSelect: " << flush;
        string choice;
        getline(cin, choice);
        if (choice == "2") break;
        if (choice != "1") continue;

        User* user = authenticate();
        if (!user) { cout << "Invalid credentials.\n"; continue; }

        if (user->getRole() == "admin") {
            while (true) {
                user->displayMenu();
                string cmd; getline(cin, cmd);
                if (cmd == "7") break;
                if (cmd == "1") adminCreateUser();
                else if (cmd == "2") adminDeleteUser();
                else if (cmd == "3") adminAddCourse();
                else if (cmd == "4") adminRemoveCourse();
                else if (cmd == "5") adminAssignTeacher();
                else if (cmd == "6") adminViewAll();
                else cout << "Unknown option.\n";
            }
        }
        else if (user->getRole() == "student") {
            while (true) {
                user->displayMenu();
                string cmd; getline(cin, cmd);
                if (cmd == "6") break;
                if (cmd == "1") studentViewAvailableCourses();
                else if (cmd == "2") studentEnroll(user->getUsername());
                else if (cmd == "3") studentViewMyCourses(user->getUsername());
                else if (cmd == "4") studentSubmitAssignment(user->getUsername());
                else if (cmd == "5") studentViewMaterials(user->getUsername());
                else cout << "Unknown option.\n";
            }
        }
        else if (user->getRole() == "teacher") {
            while (true) {
                user->displayMenu();
                string cmd; getline(cin, cmd);
                if (cmd == "5") break;
                if (cmd == "1") teacherViewMyCourses(user->getUsername());
                else if (cmd == "2") teacherViewEnrolledStudents(user->getUsername());
                else if (cmd == "3") teacherUploadMaterial(user->getUsername());
                else if (cmd == "4") teacherViewAssignments(user->getUsername());
                else cout << "Unknown option.\n";
            }
        }
        else {
            cout << "Unknown role. Contact admin.\n";
        }

        loadUsers();
        loadCourses();
        loadEnrollments();
    }

    for (size_t i = 0; i < users.size(); ++i) {
        delete users[i];
    }
    users.clear();

    cout << "Exiting LMS. Goodbye.\n";
    return 0;
}
